<!DOCTYPE html>
<html lang="en"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <title>Home</title>
</head>
<body>
<header>
    <div sec:authorize="isAuthenticated()">
        <div sec:authentication="name">User name</div>

        <form method="POST" th:action="@{/log-out}">
            <input type="submit" value="Log-out"/>
        </form>
    </div>

    <div sec:authorize="isAnonymous()">
        <form method="get" action="/log-in">
            <button>Log-in</button>
        </form>
        <form method="get" action="/log-up">
            <button>Registration</button>
        </form>
    </div>


</header>

<main sec:authorize="isAuthenticated()">

    Search
    <form method="get" th:action="@{/search}">
        <input type="text" name="query">
        <input type="submit" value="Search">
        <div>
            <p th:if="${errorSearch}" th:text="${errorSearch}" style="color:red">Create directory error</p>
        </div>
    </form>

    <br>

    Create new folder
    <form method="post" th:action="@{/directory}">
        <input type="hidden" name="current_path" th:value="${current_path}">
        <input type="text" name="name">
        <input type="submit" name="create" value="Create">
        <div>
            <p th:if="${errorCreate}" th:text="${errorCreate}" style="color:red">Create directory error</p>
        </div>

    </form>

    <br>

    File to upload:
    <form th:method="post" enctype="multipart/form-data" th:action="@{/}">
        <input type="file" name="file" multiple>
        <input name="path" type="hidden" th:value="${current_path}">
        <br/>
        <input type="submit" value="Upload">
        <div>
            <p th:if="${errorUpload}" th:text="${errorUpload}" style="color:red">Create directory error</p>
        </div>
    </form>

    <br>

    Directory to upload:
    <form th:method="post" th:action="@{/}" enctype="multipart/form-data">
        <input type="file" name="file" multiple webkitdirectory>
        <input name="path" type="hidden" th:value="${current_path}">
        <br/>
        <input type="submit" value="Upload">
        <div>
            <p th:if="${errorUpload}" th:text="${errorUpload}" style="color:red">Error</p>
        </div>
    </form>

    <br>

    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item">
                <a th:href="@{/}" th:text="root"></a>
            </li>
            <li class="breadcrumb-item" th:each="breadCrumb:${bread_crumbs}">
                <a th:href="@{/(path=${breadCrumb.link})}" th:text="${breadCrumb.name}"></a>
            </li>
        </ol>
    </nav>

    <br>

    <div th:each="entity:${objects_dir}">
        <span th:if="${!entity.isDir()}" th:text="File">Type</span>
        <span th:if="${entity.isDir()}" th:text="Folder">Type</span>

        <div th:if="${!entity.isDir()}" th:text="${entity.name}">File name</div>

        <div th:if="${entity.isDir()}">
            <a th:text="${entity.name}" th:href="@{/(path=${entity.relativePath})}">Folder Name</a>
        </div>

        <div th:if="${!entity.isDir()}">
            <form th:method="PUT" th:action="@{/file}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <input type="hidden" name="current_path" th:value="${current_path}">
                <input type="hidden" name="path" th:value="${entity.relativePath}">
                <input type="text" name="new_name">
                <input type="submit" name="rename" value="Rename">
                <div>
                    <p th:if="${errorRenameFile}" th:text="${errorRenameFile}" style="color:red">Error</p>
                </div>
            </form>
        </div>

        <div th:if="${entity.isDir()}">
            <form th:method="PUT" th:action="@{/directory}">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
                <input type="hidden" name="current_path" th:value="${current_path}">
                <input type="hidden" name="path" th:value="${entity.relativePath}">
                <input type="text" name="new_name">
                <input type="submit" name="rename" value="Rename">
                <div>
                    <p th:if="${errorRenameDir}" th:text="${errorRenameDir}" style="color:red">Error</p>
                </div>
            </form>
        </div>

        <div>
            <div th:if="${!entity.isDir()}">
                <button th:data-path="'/file?path=' + ${entity.relativePath}"
                        th:data-name="${entity.name}"
                        th:onclick="downloadFile(this.getAttribute('data-path'), this.getAttribute('data-name'))">
                    Download
                </button>
            </div>


            <div th:if="${entity.isDir()}">
                <button th:data-path="'/directory?path=' + ${entity.relativePath}"
                        th:data-name="${entity.name}"
                        th:onclick="downloadFile(this.getAttribute('data-path'), this.getAttribute('data-name'))">
                    Download
                </button>
            </div>


            <div th:if="${!entity.isDir()}">
                <form th:method="DELETE" th:action="@{/file(path=${entity.relativePath})}">
                    <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden">
                    <input type="hidden" name="current_path" th:value="${current_path}">
                    <input type="submit" name="delete" value="Delete">
                </form>
            </div>

            <div th:if="${entity.isDir()}">
                <form th:method="DELETE" th:action="@{/directory(path=${entity.relativePath})}">
                    <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden">
                    <input type="hidden" name="current_path" th:value="${current_path}">
                    <input type="submit" name="delete" value="Delete">
                </form>
            </div>
            <br>
        </div>
    </div>


    <div id="error-message" style="color:red" th:text="${errorMessage}">

    </div>
</main>


<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
</body>

<script th:inline="javascript">
    function downloadFile(path, name) {
        var header;
        var filename = "";
        fetch(path)
            .then(response => {
                header = response.headers.get('Content-Disposition');
                var filenameRegex = /filename[^;=\n]*=((['"]).*?\2|[^;\n]*)/;
                var matches = filenameRegex.exec(header);
                if (matches != null && matches[1]) {
                    filename = matches[1].replace(/['"]/g, '');
                }
                if (response.ok) {
                    return response.blob();
                }
                response.text()
                    .then(errorText => {
                            document.getElementById('error-message').innerHTML = errorText;
                        }
                    )
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');

                a.style.display = 'none';
                a.href = url;
                a.download = filename; // Укажите имя файла
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
    }
</script>
</html>